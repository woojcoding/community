<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portfolio.community.repositories.BoardMapper">

    <!-- 검색 조건에 맞는 게시글을 페이지네이션 적용하여 조회-->
    <select id="getBoardList" resultType="BoardResponseDto">
        SELECT
            b.board_id,
            b.title,
            b.content,
            b.views,
            b.notification_flag,
            b.secret_flag,
            b.answer,
            b.type,
            b.created_at,
            c.name AS categoryName,
            u.name AS writer
        FROM board b
            JOIN user u
              ON u.user_id = b.user_id
            JOIN category c
             ON c.category_id = b.category_id
        <where>
            <if test="type.code != null and type.code != ''">
                AND b.type = #{type.code}
            </if>
            <if test="startDate != null and startDate != ''">
                AND DATE(b.created_at) &gt;= DATE(#{startDate})
            </if>
            <if test="endDate != null and endDate != ''">
                AND DATE(b.created_at) &lt;= DATE(#{endDate})
            </if>
            <if test="category != null and category != ''
            and category != 'all'">
                AND b.category_id = #{category}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                <if test='type.code != "n"'>
                    u.name LIKE CONCAT('%', #{keyword}, '%') OR
                </if>
                b.title LIKE CONCAT('%', #{keyword}, '%') OR
                b.content LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
        <!-- 순서 -->
        <if test="orderOption != null and orderOption != ''">
            ORDER BY #{orderOption}
        </if>
        <if test="orderOption == null or orderOption == ''">
            ORDER BY b.created_at
        </if>
        <if test="sort != null and sort != ''">
            #{sort}
        </if>
        <if test="sort == null or sort == ''">
            DESC
        </if>
        <!-- 페이지네이션 -->
        LIMIT #{pageSize} OFFSET #{offSet}
    </select>

    <!-- 검색 조건을 적용하여 게시글의 총 개수를 조회 -->
    <select id="getTotalBoardCount" resultType="java.lang.Integer">
        SELECT COUNT(*) as totalBoardCount
        FROM board AS b
        JOIN user u
        ON u.user_id = b.user_id
        <where>
            <if test="type.code != null and type.code != ''">
                AND b.type = #{type.code}
            </if>
            <if test="startDate != null and startDate != ''">
                <![CDATA[
                AND DATE(b.created_at) >= DATE(#{startDate})
                ]]>
            </if>
            <if test="endDate != null and endDate != ''">
                <![CDATA[
                AND DATE(b.created_at) <= DATE(#{endDate})
                ]]>
            </if>
            <if test="category != null and category != ''
            and category != 'all'">
                AND b.category_id = #{category}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                <if test= 'type.code != "n"'>
                    u.name LIKE CONCAT('%', #{keyword}, '%') OR
                </if>
                b.title LIKE CONCAT('%', #{keyword}, '%') OR
                b.content LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </select>

<!--    &lt;!&ndash; 게시글을 저장&ndash;&gt;-->
<!--    <insert id="postBoard" useGeneratedKeys="true" keyProperty="boardId">-->
<!--        INSERT INTO board(-->
<!--                          title,-->
<!--                          content,-->
<!--                          status,-->
<!--                          user_id,-->
<!--                          category_id-->
<!--                          )-->
<!--        VALUES (-->
<!--                #{title},-->
<!--                #{content},-->
<!--                #{status},-->
<!--                #{userId},-->
<!--                #{categoryId},-->
<!--                )-->
<!--    </insert>-->

<!--    &lt;!&ndash; 게시글 수정에 필요한 정보들을 조회 &ndash;&gt;-->
<!--    <select id="getBoard" resultType="BoardRequestDto">-->
<!--        SELECT title,-->
<!--               content,-->
<!--               status,-->
<!--               answer,-->
<!--               category_id-->
<!--        FROM board-->
<!--        WHERE board_id = #{boardId}-->
<!--    </select>-->

<!--    &lt;!&ndash; 게시글Id에 해당하는 게시글 수정 &ndash;&gt;-->
<!--    <update id="updateBoard">-->
<!--        UPDATE board-->
<!--        SET category_id = #{categoryId},-->
<!--            title = #{title},-->
<!--            content = #{content},-->
<!--            status = #{status},-->
<!--            answer = #{answer}-->
<!--        WHERE board_id = #{boardId}-->
<!--    </update>-->
</mapper>
